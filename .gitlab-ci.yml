# GitLab CI/CD Configuration for Post Dominator
# Next.js Social Media Scheduler App

stages:
  - build
  - test
  - deploy

variables:
  NODE_VERSION: "20"
  NEXT_TELEMETRY_DISABLED: "1"
  CI: "true"

# Cache node_modules for faster builds
cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .next/cache

# Build stage
build:
  stage: build
  image: node:${NODE_VERSION}-alpine
  before_script:
    - apk add --no-cache libc6-compat
    - npm ci
  script:
    - npm run build
  artifacts:
    paths:
      - .next/
      - public/
      - package.json
      - package-lock.json
      - node_modules/
    expire_in: 1 hour
  only:
    - main
    - master
    - develop
    - merge_requests

# Lint stage
lint:
  stage: test
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm ci
  script:
    - npm run lint
  allow_failure: true
  only:
    - main
    - master
    - develop
    - merge_requests

# Type check stage
typecheck:
  stage: test
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm ci
  script:
    - npx tsc --noEmit
  allow_failure: true
  only:
    - main
    - master
    - develop
    - merge_requests

# Format check stage
format-check:
  stage: test
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm ci
  script:
    - npm run format:check
  allow_failure: true
  only:
    - main
    - master
    - develop
    - merge_requests

# Deploy to production
deploy:production:
  stage: deploy
  image: node:${NODE_VERSION}-alpine
  environment:
    name: production
    url: $PRODUCTION_URL
  before_script:
    - apk add --no-cache libc6-compat curl
    - npm ci --production=false
  script:
    - echo "Deploying to production..."
    # Add your deployment commands here
    # Examples:
    # - For Vercel: npx vercel --prod --token=$VERCEL_TOKEN
    # - For self-hosted: rsync -avz .next/ user@server:/app/
    # - For Docker: docker build -t post-dominator . && docker push $REGISTRY/post-dominator
    - |
      if [ -n "$DEPLOY_SCRIPT" ]; then
        eval "$DEPLOY_SCRIPT"
      else
        echo "No deployment script configured. Set DEPLOY_SCRIPT variable in GitLab CI/CD settings."
        echo "Example: npm run build && npm run start"
      fi
  only:
    - main
    - master
  when: manual
  dependencies:
    - build

# Deploy to staging
deploy:staging:
  stage: deploy
  image: node:${NODE_VERSION}-alpine
  environment:
    name: staging
    url: $STAGING_URL
  before_script:
    - apk add --no-cache libc6-compat curl
    - npm ci --production=false
  script:
    - echo "Deploying to staging..."
    - |
      if [ -n "$STAGING_DEPLOY_SCRIPT" ]; then
        eval "$STAGING_DEPLOY_SCRIPT"
      else
        echo "No staging deployment script configured."
      fi
  only:
    - develop
  when: manual
  dependencies:
    - build

# Docker build (optional - uncomment if using Docker)
# docker:build:
#   stage: build
#   image: docker:latest
#   services:
#     - docker:dind
#   before_script:
#     - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
#   script:
#     - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG -t $CI_REGISTRY_IMAGE:latest .
#     - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
#     - docker push $CI_REGISTRY_IMAGE:latest
#   only:
#     - main
#     - master
#     - develop

# Cleanup old artifacts
cleanup:
  stage: deploy
  image: alpine:latest
  script:
    - echo "Cleaning up old artifacts..."
  only:
    - schedules
  when: manual

